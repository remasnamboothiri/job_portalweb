<!-- Edit Job Modal Content -->
<form method="post" enctype="multipart/form-data" id="editJobForm" action="">
  {% csrf_token %}
  
  <div class="row">
    <!-- Featured Image Upload -->
    <div class="col-12 mb-3">
      <label for="{{ form.featured_image.id_for_label }}" class="form-label">
        <i class="fas fa-image me-2"></i>Featured Image
      </label>
      
      {% if job.featured_image %}
        <div class="mb-2">
          <img src="{{ job.featured_image.url }}" alt="Current image" class="img-thumbnail" style="max-width: 150px; max-height: 100px; object-fit: cover;">
          <small class="text-muted d-block">Current image</small>
        </div>
      {% endif %}
      
      <div class="file-upload-area-modal" onclick="document.getElementById('{{ form.featured_image.id_for_label }}').click()">
        <div class="text-center p-3 border rounded bg-light">
          <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
          <div>Click to upload new image</div>
          <small class="text-muted">PNG, JPG, GIF up to 5MB</small>
        </div>
      </div>
      
      {{ form.featured_image }}
      
      <div class="selected-file-modal mt-2" id="selectedFileModal" style="display: none;">
        <div class="alert alert-info">
          <strong>Selected:</strong> <span id="fileNameModal"></span> (<span id="fileSizeModal"></span>)
        </div>
      </div>
      
      {% if form.featured_image.errors %}
        <div class="text-danger">{{ form.featured_image.errors.0 }}</div>
      {% endif %}
    </div>
  </div>

  <div class="row">
    <!-- Job Title -->
    <div class="col-md-6 mb-3">
      <label for="{{ form.title.id_for_label }}" class="form-label">Job Title *</label>
      {{ form.title }}
      {% if form.title.errors %}
        <div class="text-danger">{{ form.title.errors.0 }}</div>
      {% endif %}
    </div>

    <!-- Company Name -->
    <div class="col-md-6 mb-3">
      <label for="{{ form.company.id_for_label }}" class="form-label">Company Name *</label>
      {{ form.company }}
      {% if form.company.errors %}
        <div class="text-danger">{{ form.company.errors.0 }}</div>
      {% endif %}
    </div>
  </div>

  <div class="row">
    <!-- Department -->
    <div class="col-md-6 mb-3">
      <label for="{{ form.department.id_for_label }}" class="form-label">Department</label>
      {{ form.department }}
      {% if form.department.errors %}
        <div class="text-danger">{{ form.department.errors.0 }}</div>
      {% endif %}
    </div>

    <!-- Location -->
    <div class="col-md-6 mb-3">
      <label for="{{ form.location.id_for_label }}" class="form-label">Location *</label>
      {{ form.location }}
      {% if form.location.errors %}
        <div class="text-danger">{{ form.location.errors.0 }}</div>
      {% endif %}
    </div>
  </div>

  <div class="row">
    <!-- Employment Type -->
    <div class="col-md-6 mb-3">
      <label for="{{ form.employment_type.id_for_label }}" class="form-label">Employment Type</label>
      {{ form.employment_type }}
      {% if form.employment_type.errors %}
        <div class="text-danger">{{ form.employment_type.errors.0 }}</div>
      {% endif %}
    </div>

    <!-- Experience Level -->
    <div class="col-md-6 mb-3">
      <label for="{{ form.experience_level.id_for_label }}" class="form-label">Experience Level</label>
      {{ form.experience_level }}
      {% if form.experience_level.errors %}
        <div class="text-danger">{{ form.experience_level.errors.0 }}</div>
      {% endif %}
    </div>
  </div>

  <div class="row">
    <!-- Salary Min -->
    <div class="col-md-6 mb-3">
      <label for="{{ form.salary_min.id_for_label }}" class="form-label">Salary Min ($)</label>
      {{ form.salary_min }}
      {% if form.salary_min.errors %}
        <div class="text-danger">{{ form.salary_min.errors.0 }}</div>
      {% endif %}
    </div>

    <!-- Salary Max -->
    <div class="col-md-6 mb-3">
      <label for="{{ form.salary_max.id_for_label }}" class="form-label">Salary Max ($)</label>
      {{ form.salary_max }}
      {% if form.salary_max.errors %}
        <div class="text-danger">{{ form.salary_max.errors.0 }}</div>
      {% endif %}
    </div>
  </div>

  <!-- Job Description -->
  <div class="mb-3">
    <label for="{{ form.description.id_for_label }}" class="form-label">Job Description *</label>
    {{ form.description }}
    {% if form.description.errors %}
      <div class="text-danger">{{ form.description.errors.0 }}</div>
    {% endif %}
  </div>

  <!-- Required Skills -->
  <div class="mb-3">
    <label for="{{ form.required_skills.id_for_label }}" class="form-label">Required Skills</label>
    {{ form.required_skills }}
    {% if form.required_skills.errors %}
      <div class="text-danger">{{ form.required_skills.errors.0 }}</div>
    {% endif %}
  </div>

  <!-- Job Status -->
  <div class="mb-3">
    <label for="{{ form.status.id_for_label }}" class="form-label">Job Status</label>
    {{ form.status }}
    {% if form.status.errors %}
      <div class="text-danger">{{ form.status.errors.0 }}</div>
    {% endif %}
  </div>

  <!-- AI Interview Settings -->
  <div class="border-top pt-3">
    <h6>AI Interview Settings</h6>
    
    <div class="form-check mb-3">
      {{ form.enable_ai_interview }}
      <label for="{{ form.enable_ai_interview.id_for_label }}" class="form-check-label">
        Enable AI Interview for this position
      </label>
    </div>

    <div class="row" id="aiSettingsModal" style="display: none;">
      <div class="col-md-6 mb-3">
        <label for="{{ form.interview_duration.id_for_label }}" class="form-label">Interview Duration</label>
        {{ form.interview_duration }}
      </div>
      <div class="col-md-6 mb-3">
        <label for="{{ form.interview_question_count.id_for_label }}" class="form-label">Question Count</label>
        {{ form.interview_question_count }}
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
    <button type="submit" class="btn btn-primary">Update Job</button>
  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Hide file input
  const fileInput = document.getElementById('{{ form.featured_image.id_for_label }}');
  if (fileInput) {
    fileInput.style.display = 'none';
    
    // Handle file selection
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        document.getElementById('fileNameModal').textContent = file.name;
        document.getElementById('fileSizeModal').textContent = formatFileSize(file.size);
        document.getElementById('selectedFileModal').style.display = 'block';
      }
    });
  }
  
  // Format file size function
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
  
  // Add Bootstrap classes to form fields
  const formControls = document.querySelectorAll('#editJobForm input, #editJobForm textarea, #editJobForm select');
  formControls.forEach(function(control) {
    if (!control.classList.contains('form-control') && !control.classList.contains('form-check-input')) {
      control.classList.add('form-control');
    }
  });
  
  // Handle AI interview settings toggle
  const aiCheckbox = document.getElementById('{{ form.enable_ai_interview.id_for_label }}');
  const aiSettings = document.getElementById('aiSettingsModal');
  
  function toggleAISettings() {
    if (aiCheckbox && aiSettings) {
      aiSettings.style.display = aiCheckbox.checked ? 'block' : 'none';
    }
  }
  
  if (aiCheckbox) {
    toggleAISettings(); // Initial check
    aiCheckbox.addEventListener('change', toggleAISettings);
  }
  
  // Handle form submission
  document.getElementById('editJobForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Debug: Log form data
    console.log('Form submission started');
    console.log('Form action:', this.action);
    console.log('Form method:', this.method);
    console.log('Form enctype:', this.enctype);
    
    // Debug: Check if image file is included
    const imageFile = formData.get('featured_image');
    if (imageFile && imageFile.size > 0) {
      console.log('Image file found:', imageFile.name, 'Size:', imageFile.size);
    } else {
      console.log('No image file or empty file');
    }
    
    // Show loading state
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Updating...';
    submitBtn.disabled = true;
    
    // Clear previous errors
    document.querySelectorAll('.text-danger').forEach(el => {
      if (el.classList.contains('mt-1')) el.remove();
    });
    
    fetch(this.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
        // Note: Don't set Content-Type header when using FormData
        // The browser will set it automatically with the correct boundary
      }
    })
    .then(response => response.json())
    .then(data => {
      console.log('Response received:', data);
      if (data.success) {
        // Show success message and close modal
        alert('Job updated successfully!' + (data.image_url ? ' Image updated.' : ''));
        const modal = bootstrap.Modal.getInstance(document.getElementById('editJobModal'));
        modal.hide();
        location.reload(); // Refresh to show updated data
      } else {
        // Show errors
        alert('Error updating job: ' + (data.message || 'Please check the form and try again.'));
        
        // Display field-specific errors
        if (data.errors) {
          Object.keys(data.errors).forEach(field => {
            const fieldElement = document.querySelector(`[name="${field}"]`);
            if (fieldElement) {
              const errorDiv = document.createElement('div');
              errorDiv.className = 'text-danger mt-1';
              errorDiv.textContent = data.errors[field][0];
              fieldElement.parentNode.appendChild(errorDiv);
            }
          });
        }
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error updating job. Please try again.');
    })
    .finally(() => {
      // Restore button state
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    });
  });
});
</script>

<style>
.file-upload-area-modal {
  cursor: pointer;
  transition: all 0.3s ease;
}

.file-upload-area-modal:hover {
  opacity: 0.8;
}

#editJobForm .form-control, 
#editJobForm .form-select {
  border-radius: 6px;
  border: 1px solid #ddd;
}

#editJobForm .form-control:focus, 
#editJobForm .form-select:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

#editJobForm textarea {
  resize: vertical;
  min-height: 100px;
}
</style>