<!-- Quick fix script to add to interview template -->
<script>
// Override the processSpeechResult function with better error handling
window.processSpeechResult = async function(speechText) {
    try {
        console.log('Processing speech result:', speechText);
        
        // Show sending status
        const statusElement = document.getElementById('responseStatus');
        if (statusElement) {
            statusElement.innerHTML = 'ðŸ“¤ Sending your response...';
        }
        
        // Get CSRF token with multiple fallback methods
        function getCSRFToken() {
            // Method 1: Hidden input
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfInput && csrfInput.value) {
                return csrfInput.value;
            }
            
            // Method 2: Cookie
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }
            
            // Method 3: Meta tag
            const csrfMeta = document.querySelector('meta[name=csrf-token]');
            if (csrfMeta) {
                return csrfMeta.getAttribute('content');
            }
            
            console.warn('CSRF token not found');
            return '';
        }
        
        // Prepare request with multiple format support
        const formData = new URLSearchParams();
        formData.append('text', speechText);
        
        const csrfToken = getCSRFToken();
        console.log('Using CSRF token:', csrfToken ? 'Found' : 'Missing');
        
        // Send request with enhanced error handling
        const response = await fetch(window.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData,
            credentials: 'same-origin'  // Include cookies
        });
        
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            if (response.status === 403) {
                throw new Error('Session expired. Please refresh the page.');
            } else if (response.status === 404) {
                throw new Error('Interview not found.');
            } else if (response.status >= 500) {
                throw new Error('Server error. Please try again.');
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Invalid response format from server');
        }
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            if (typeof handleAIResponse === 'function') {
                handleAIResponse(data);
            } else {
                console.error('handleAIResponse function not found');
                if (statusElement) {
                    statusElement.innerHTML = 'âœ… Response received: ' + data.response;
                }
            }
        } else {
            console.error('Backend error:', data.error);
            if (statusElement) {
                statusElement.innerHTML = 'âŒ Error: ' + (data.error || 'Unknown error');
            }
        }
        
    } catch (error) {
        console.error('Network error:', error);
        const statusElement = document.getElementById('responseStatus');
        
        if (error.message.includes('Session expired') || error.message.includes('403')) {
            if (statusElement) {
                statusElement.innerHTML = 'ðŸ”„ Session expired. Refreshing page...';
            }
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
            if (statusElement) {
                statusElement.innerHTML = 'âŒ Connection error. Check your internet and try again.';
            }
        } else {
            if (statusElement) {
                statusElement.innerHTML = 'âŒ Error: ' + error.message;
            }
        }
        
        // Reset UI after error
        setTimeout(() => {
            if (statusElement && !error.message.includes('Session expired')) {
                statusElement.innerHTML = 'Microphone is ready. You can speak anytime.';
            }
        }, 5000);
    }
};

// Also fix the sendTextResponse function
window.sendTextResponse = async function(text) {
    return await processSpeechResult(text);
};

console.log('Interview fix script loaded');
</script>